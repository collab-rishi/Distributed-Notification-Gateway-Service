name: API Gateway CI/CD

on:
  push:
    branches:
      - main
      - develop
    
  pull_request:
    branches:
      - main
      - develop
    

jobs:
  # ---------------------------------------------------
  # ðŸ”‘ JOB 1: CI Checks (Install, Build, Test)
  # ---------------------------------------------------
  ci_checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: . # Set default directory for all steps

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use a stable Node.js version

      - name: 3. Cache Node Modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ./node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: 4. Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install

      - name: 5. Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # NOTE: Assuming you have a standard NestJS build script defined in package.json
      - name: 6. Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RABBITMQ_URL: ${{ secrets.RABBITMQ_URL }}  # <-- NEW
          API_KEY_SECRET: ${{ secrets.API_KEY_SECRET }} # <-- NEW
      
      # NOTE: Uncomment this when you add unit and integration tests
      # - name: 6. Run Tests
      #   run: npm run test:cov 
        
      # You can add linting checks here if desired
      
  # ---------------------------------------------------
  # ðŸ”‘ JOB 2: Build and Push Docker image (Depends on successful CI checks)
  # ---------------------------------------------------
  build_and_push:
    needs: ci_checks # ðŸ”‘ CRITICAL: Only run if the CI checks job succeeds
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 3. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 4. Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/distributed-notification-gateway:latest
            ${{ secrets.DOCKER_USERNAME }}/distributed-notification-gateway:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 5. Deploy to Staging (Placeholder)
        run: |
          echo "Deployment script for staging environment would run here."